package engine

import (
	"os"
)

///////////////////////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////////////////////
type Template struct {
	RawName      string   `json:"name" yaml:"name"`
	RawImage     string   `json:"image" yaml:"image"`
	Requirements []string `json:"required" yaml:"required"`
	Run          RunParameters
}

/////////////////////////////////////////////////////////////////////////////////////////////////
////
/////////////////////////////////////////////////////////////////////////////////////////////////
func (tmp *Template) Name() string {
	return os.ExpandEnv(tmp.RawName)
}

/////////////////////////////////////////////////////////////////////////////////////////////////
////
/////////////////////////////////////////////////////////////////////////////////////////////////
func (tmp *Template) Image() string {
	return os.ExpandEnv(tmp.RawImage)
}

/////////////////////////////////////////////////////////////////////////////////////////////////
////
/////////////////////////////////////////////////////////////////////////////////////////////////
type ClusterNode struct {
	Id      string `json:"id" yaml:"id"`
	Address string `json:"address" yaml:"address"`
}

///////////////////////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////////////////////
type Manifest struct {
	Id        string              `json:"manifest-id" yaml:"manifest-id"`
	Templates []Template          `json:"containers" yaml:"containers"`
	Groups    map[string][]string `json:"groups" yaml:"groups"`
	Nodes     []ClusterNode       `json:"nodes" yaml:"nodes"`
}

///////////////////////////////////////////////////////////////////////////////////////////////
// templateInGroup
///////////////////////////////////////////////////////////////////////////////////////////////
func templateInGroup(tmp Template, names []string) bool {
	for _, name := range names {
		if os.ExpandEnv(name) == tmp.Name() {
			return true
		}
	}
	return false
}

///////////////////////////////////////////////////////////////////////////////////////////////
// GetContainersByNames
///////////////////////////////////////////////////////////////////////////////////////////////
func (m *Manifest) GetTemplatesByNames(names []string) []Template {
	var filtered []Template
	for _, cnt := range m.Templates {
		if templateInGroup(cnt, names) {
			filtered = append(filtered, cnt)
		}
	}

	return filtered
}

///////////////////////////////////////////////////////////////////////////////////////////////
//GetContainerNamesByGroup
///////////////////////////////////////////////////////////////////////////////////////////////
func (m *Manifest) GetTemplateNamesByGroup(group string) []string {
	// If group is not given, all containers
	if len(group) == 0 {
		var names []string
		for _, tmp := range m.Templates {
			names = append(names, tmp.Name())
		}
		return names
	}
	// Select specified group from listed groups
	for groupName, containerNames := range m.Groups {
		if groupName == group {
			return containerNames
		}
	}
	// The group might just be a container reference itself
	var names []string
	for _, tmp := range m.Templates {
		if tmp.Name() == group {
			names = append(names, group)
		}
	}

	return names
}
